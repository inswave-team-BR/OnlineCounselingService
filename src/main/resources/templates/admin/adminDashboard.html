<div th:fragment="content">
  <main class="dashboard-content">
    <!-- 첫 번째 행: 계약서 상태와 월별 서명요청 현황 -->
    <div class="row">
      <!-- 계약서 상태 카드 -->
      <div class="col-md-6 mb-4">
        <div class="card h-100">

          <div class="card-header">
            <h3 class="card-title">계약서 상태</h3>
            <div>
              <input id ="contractTime" type="month"/>
              <button id ="contractStatusByMonthReset" class="btn btn-sm btn-outline-secondary ms-1">
                <i class="bi bi-arrow-repeat"></i>
              </button>
            </div>
          </div>

          <div class="card-body d-flex flex-column">
            <!-- 도넛 차트 영역 -->
            <div class="chart-container position-relative">
              <canvas id="contractStatusChart"></canvas>
<!--              <div class="no-data">표시할 데이터가 없습니다.</div>-->
            </div>

            <!-- 계약 현황 리스트 -->
            <div class="mt-3">
              <div class="fw-bold mb-2">나의 계약 현황</div>
              <ul class="status-list">
                <li class="status-item">
                  <div class="status-label">진행중 계약</div>
                  <div class="status-value">1</div>
                </li>
                <li class="status-item">
                  <div class="status-label">완료된 계약</div>
                  <div class="status-value">2</div>
                </li>
                <li class="status-item">
                  <div class="status-label">취소/거절된 계약</div>
                  <div class="status-value">3</div>
                </li>
                <li class="status-item">
                  <div class="status-label">대기중 계약</div>
                  <div class="status-value">4</div>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 월별 서명요청 현황 카드 -->
      <div class="col-md-6 mb-4">
        <div class="card h-100">
          <div class="card-header">
            <h3 class="card-title">월별 계약 완료 현황</h3>
            <div>
              <button class="btn btn-sm btn-outline-secondary ms-2">
                <i class="bi bi-list-ul"></i>
              </button>
              <button class="btn btn-sm btn-outline-secondary ms-1">
                <i class="bi bi-arrow-repeat"></i>
              </button>
            </div>
          </div>

          <div class="card-body">
            <!-- 바 차트 영역 -->
            <div class="chart-container">
              <canvas id="signRequestChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 두 번째 행: 이용 가이드와 주요기능 -->
    <div class="row">
      <!-- 주요기능 바로 시작하기 카드 -->
      <div class="col-md-12 mb-4">
        <div class="card h-100">
          <div class="card-header">
            <h3 class="card-title">주요기능 바로 시작하기</h3>
            <div>계약서 생성부터 편집까지, 클릭 몇 번으로 계약을 완료하세요.</div>
          </div>
          <div class="card-body p-0">
            <ul class="feature-list">
              <li class="feature-item">
                <div class="feature-title">일반서명</div>
                <div class="feature-desc">대면 없이 메일을 통한 빠른 계약</div>
              </li>
              <li class="feature-item">
                <div class="feature-title">대면서명</div>
                <div class="feature-desc">하나의 디바이스로 여러 참여자 서명</div>
              </li>
              <li class="feature-item">
                <div class="feature-title">순차서명</div>
                <div class="feature-desc">최대 10명의 수신자가 순차적으로 서명</div>
              </li>
              <li class="feature-item">
                <div class="feature-title">대량서명</div>
                <div class="feature-desc">다수의 수신자에게 발송</div>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 세 번째 행: 최근 완료된 계약과 진행중 계약 -->
    <div class="row">
      <!-- 최근 완료된 계약 카드 -->
      <div class="col-md-6 mb-4">
        <div class="card h-100">
          <div class="card-header">
            <h3 class="card-title">최근 완료된 계약</h3>
            <button class="btn btn-sm btn-outline-secondary">
              <i class="bi bi-list-ul"></i>
            </button>
          </div>

          <div class="card-body">
            <ul class="list-group list-group-flush">
              <li class="list-group-item text-center text-muted py-4">완료된 계약이 없습니다.</li>
            </ul>
          </div>
        </div>
      </div>
      
      <!-- 진행중 계약 카드 -->
      <div class="col-md-6 mb-4">
        <div class="card h-100">
          <div class="card-header">
            <h3 class="card-title">진행 중인 계약</h3>
            <button class="btn btn-sm btn-outline-secondary">
              <i class="bi bi-list-ul"></i>
            </button>
          </div>
          <div class="card-body">
            <ul class="list-group list-group-flush">
              <li class="list-group-item text-center text-muted py-4">진행 중인 계약이 없습니다.</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 네 번째 행: SignSquare Blog -->
    <div class="row">
      <div class="col-12 mb-4">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Visang Blog</h3>
          </div>
          <div class="card-body">
            <h5 class="mb-2">AI 전자계약 서비스 Visang 공식 출시</h5>
            <p>AI·DX 전문기업 인스웨이브시스템즈(450520, 대표 어세룡)가 전자서명 원스톱 AI 서비스인 '싸인스퀘어(SignSquare)'를 공식 출시하고, 신규 가입자를 대상으로 무료 이용 프로모션을 진행한다고 25일 밝혔다.</p>
          </div>
        </div>
      </div>
    </div>
    
  </main>
</div>

<script th:fragment="script">
  document.addEventListener('DOMContentLoaded', () => {

    // 현재 년도과 월을 가져옵니다.
    const year = new Date().getFullYear();
    const month = new Date().getMonth() + 1; // 월은 0부터 시작하므로 +1

    let statusChart;
    const contractTime = document.getElementById("contractTime");
    const resetContractStatusByMonth = document.getElementById("contractStatusByMonthReset");


    if (!contractTime.value) {
      contractTime.value = new Date().toISOString().slice(0, 7);
    }

    contractTime.addEventListener('change', (event) => {
      console.log("값 변화")
      const selectedDate = new Date(event.target.value);
      const year = selectedDate.getFullYear();
      const month = selectedDate.getMonth() + 1; // 월은 0부터 시작하므로 +1
      console.log(`Selected Year: ${year}, Month: ${month}`);
    });

    resetContractStatusByMonth.addEventListener('click', () => {
      // 데이터 다시 가져오기
      contractTime.value = new Date().toISOString().slice(0, 7);
      console.log("reset");
    });

    function renderStatusChart(data) {
      const canvas = document.getElementById('contractStatusChart');

      const existingChart = Chart.getChart(canvas);
        if (existingChart) {
            existingChart.destroy();
        }

      const ctx = canvas.getContext('2d');

      statusChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['진행중', '완료', '취소/거절', '대기중'],
          datasets: [{
            data: data,
            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'],
            hoverOffset: 4
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
            },
            tooltip: {
              callbacks: {
                label: function(tooltipItem) {
                  return tooltipItem.label + ': ' + tooltipItem.raw;
                }
              }
            }
          }
        }
      });
    }

    // Ajax로 서버에서 가져오기
    async function fetchAndRenderStatus(year, month) {
      // default month=현재월
      const res = await fetch(`/admin/contract-status/month?year=${year||'2025'}&month=${month||'05'}`);
      const json = await res.json();
        console.log(json);
      const data = [
        json.inProgressCount,
        json.completedCount,
        json.canceledCount,
        json.pendingCount
      ];
      renderStatusChart(data);
      // 아래 “나의 계약 현황” 숫자도 업데이트
      document.querySelector('.status-item:nth-child(1) .status-value').textContent = json.inProgressCount;
      document.querySelector('.status-item:nth-child(2) .status-value').textContent = json.completedCount;
      document.querySelector('.status-item:nth-child(3) .status-value').textContent = json.canceledCount;
      document.querySelector('.status-item:nth-child(4) .status-value').textContent = json.pendingCount;
    }


    fetchAndRenderStatus(year, month);

  });

</script>
