<!-- src/main/resources/templates/admin/adminAgentManagement.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>상담사 관리</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet"/>
  <!-- 공통 CSS -->
  <link rel="stylesheet" th:href="@{/css/common/main.css}" />

</head>
<body>
<!-- Thymeleaf Fragment 정의 -->
<div th:fragment="content">
  <main class="dashboard-content container-fluid py-4">
    <!-- 타이틀-->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3>상담사 관리</h3>
      <!-- 1) 검색 폼 -->
      <form id ="searchForm" class="row row-cols-auto gx-2 gy-2 align-items-center mb-3">
        <div class="col">
          <input type="text"
                 name="name"
                 class="form-control form-control-sm"
                 placeholder="이름"
                 th:value="${param.name}"/>
        </div>
        <div class="col">
          <input type="text"
                 name="email"
                 class="form-control form-control-sm"
                 placeholder="이메일"
                 th:value="${param.email}"/>
        </div>
        <div class="col">
          <select name="state"
                  class="form-select form-select-sm">
            <option value="">상태</option>
            <option value="ACTIVE"
                    th:selected="${param.state=='ACTIVE'}">활성</option>
            <option value="ON_LEAVE"
                    th:selected="${param.state=='ON_LEAVE'}">휴직</option>
            <option value="RETIRED"
                    th:selected="${param.state=='RETIRED'}">퇴직</option>
          </select>
        </div>
        <div class="col">
          <button id="search-button" type="submit" class="btn btn-primary btn-sm">
            <i class="bi bi-search me-1"></i> 검색
          </button>
        </div>
        <div class="col">
          <button type="button" class="btn btn-outline-secondary btn-sm" id="reset-button">
            초기화
          </button>
        </div>
      </form>
    </div>

    <!-- 3) 상담사 리스트 -->
    <div class="table-responsive mb-4">
      <table class="table table-striped table-hover align-middle">
        <thead class="table-light">
        <tr>
          <th>ID</th>
          <th>이름</th>
          <th>이메일</th>
          <th>전화번호</th>
          <th>상태</th>
          <th>액션</th>
        </tr>
        </thead>
        <tbody id="agentTableBody">
        <tr th:each="agent : ${agentList}"
            th:data-href="@{/admin/detail/{id}(id=${agent.agentId})}">
          <td th:text="${agent.agentId}">1</td>
          <td th:text="${agent.name}">홍길동</td>
          <td th:text="${agent.email}">hong@example.com</td>
          <td th:text="${agent.phoneNumber}">010-1234-5678</td>
          <td>
            <div th:switch="${agent.state}">
              <span th:case="'ACTIVE'"  class="badge bg-success"   th:text="'활성'">활성</span>
              <span th:case="'ON_LEAVE'" class="badge bg-warning"   th:text="'휴직'">휴직</span>
              <span th:case="'RETIRED'"  class="badge bg-secondary" th:text="'퇴직'">퇴직</span>
              <span th:case="*"
                    class="badge bg-light text-dark"
                    th:text="${agent.state}">미정</span>
            </div>
          </td>
          <td class="d-flex gap-1">
            <!-- ACTIVE → ON_LEAVE -->
            <form th:if="${agent.state=='ACTIVE'}"
                  th:action="@{/admin/state/{id}(id=${agent.agentId})}"
                  method="post"
                  onsubmit="return confirm('정말 이 상담사를 휴직 처리하시겠습니까?');">
              <input type="hidden" name="state" value="ON_LEAVE"/>
              <button type="submit" class="btn btn-sm btn-outline-warning">휴직</button>
            </form>
            <!-- ON_LEAVE → ACTIVE -->
            <form th:if="${agent.state=='ON_LEAVE'}"
                  th:action="@{/admin/state/{id}(id=${agent.agentId})}"
                  method="post"
                  onsubmit="return confirm('정말 상담사를 복귀 처리하시겠습니까?');">
              <input type="hidden" name="state" value="ACTIVE"/>
              <button type="submit" class="btn btn-sm btn-outline-success">복귀</button>
            </form>
            <!-- 퇴직 -->
            <form th:unless="${agent.state=='RETIRED'}"
                  th:action="@{/admin/state/{id}(id=${agent.agentId})}"
                  method="post"
                  onsubmit="return confirm('정말 상담사를 퇴직 처리하시겠습니까?');">
              <input type="hidden" name="state" value="RETIRED"/>
              <button type="submit" class="btn btn-sm btn-outline-dark">퇴직</button>
            </form>
            <!-- 정보 수정 -->
            <a th:href="@{/admin/edit/{id}(id=${agent.agentId})}"
               class="btn btn-sm btn-outline-primary">수정</a>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
  </main>
</div>

<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!--  행 클릭 이동 스크립트 -->
<script th:fragment="script">
  document.addEventListener('DOMContentLoaded', () => {
    const searchForm = document.getElementById('searchForm');
    const tableBody  = document.getElementById('agentTableBody');

    // 초기화 버튼
    const resetButton = document.getElementById('reset-button');
    resetButton.addEventListener('click', () => {
      searchForm.reset(); // 모든 input/select 초기화
    });

    // 테이블 행 클릭 → 상세 페이지
    function attachRowClick() {
      tableBody.querySelectorAll('tr').forEach(row => {
        row.style.cursor = 'pointer';
        row.addEventListener('click', () => {
          window.location.href = row.dataset.href;
        });
      });
    }
    // 테이블 초기화 후 다시 그리기
    function renderTable(agentList) {
      tableBody.innerHTML = ''; // 기존 행 삭제

      if (!agentList || agentList.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML=`
          <td colspan="6" class="text-center">검색 결과가 없습니다.</td>
        `;
        tableBody.appendChild(row);
        return;
      }

      agentList.forEach(agent => {
        const row = document.createElement('tr');
        row.dataset.href = `/admin/detail/${agent.agentId}`;

        row.innerHTML = `
        <td>${agent.agentId}</td>
        <td>${agent.name}</td>
        <td>${agent.email}</td>
        <td>${agent.phoneNumber}</td>
        <td>
          <span class="badge ${
                agent.state === 'ACTIVE' ? 'bg-success' :
                        agent.state === 'ON_LEAVE' ? 'bg-warning' :
                                agent.state === 'RETIRED' ? 'bg-secondary' : 'bg-light text-dark'
        }">${{
          ACTIVE: '활성',
          ON_LEAVE: '휴직',
          RETIRED: '퇴직'
        }[agent.state] || agent.state}</span>
        </td>
        <td class="d-flex gap-1">
          ${agent.state === 'ACTIVE' ? `
            <form action="/admin/state/${agent.agentId}" method="post" onsubmit="return confirm('정말 이 상담사를 휴직 처리하시겠습니까?');">
              <input type="hidden" name="state" value="ON_LEAVE"/>
              <button type="submit" class="btn btn-sm btn-outline-warning">휴직</button>
            </form>` : ''}
          ${agent.state === 'ON_LEAVE' ? `
            <form action="/admin/state/${agent.agentId}" method="post" onsubmit="return confirm('정말 상담사를 복귀 처리하시겠습니까?');">
              <input type="hidden" name="state" value="ACTIVE"/>
              <button type="submit" class="btn btn-sm btn-outline-success">복귀</button>
            </form>` : ''}
          ${agent.state !== 'RETIRED' ? `
            <form action="/admin/state/${agent.agentId}" method="post" onsubmit="return confirm('정말 상담사를 퇴직 처리하시겠습니까?');">
              <input type="hidden" name="state" value="RETIRED"/>
              <button type="submit" class="btn btn-sm btn-outline-dark">퇴직</button>
            </form>` : ''}
          <a href="/admin/edit/${agent.agentId}" class="btn btn-sm btn-outline-primary">수정</a>
        </td>
      `;

        tableBody.appendChild(row);
      });

      attachRowClick();
    }

    // 검색 이벤트 비동기 처리
    searchForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(searchForm);
      const params = new URLSearchParams(formData);
      try {
        const response = await fetch(`/admin/search?${params.toString()}`);
        if (!response.ok) throw new Error('서버 오류');

        const data = await response.json(); // [{agentId, name, ...}, ...]
        renderTable(data);
      } catch (err) {
        alert('검색 중 오류가 발생했습니다.');
        console.error(err);
      }
    });

    // 최초 실행
    attachRowClick();
  });
</script>
</body>
</html>


